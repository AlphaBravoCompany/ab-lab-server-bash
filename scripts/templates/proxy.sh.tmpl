#!/bin/bash

set -e
G="\e[32m"
E="\e[0m"

if ! grep -q 'Ubuntu' /etc/issue
  then
    echo -----------------------------------------------
    echo "Not Ubuntu? Could not find Codename Ubuntu in lsb_release -a. Please switch to Ubuntu."
    echo -----------------------------------------------
    exit 1
fi

## Change ownership of SSH Key
chmod 0600 /root/.ssh/id_rsa

## Generate cert with mkcert
mkcert -install
cd /alphabravo/misc/certs
mkcert "*.$proxy_ip.nip.io"
#cat /alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io.pem /alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io-key.pem | tee cert-bundle.pem
#docker run -v /alphabravo/misc/certs:/certs -e SSL_DNS="*.$proxy_ip.nip.io" -e SSL_IP="$proxy_ip" -e SSL_EXPIRE="90" -e SSL_SUBJECT="$proxy_ip.nip.io" paulczar/omgwtfssl
#docker run -v /alphabravo/misc/certs:/certs -e SSL_DNS="*.$lab_server_ip.nip.io,*.$proxy_ip.nip.io,$lab_server_ip.nip.io,$proxy_ip.nip.io" -e SSL_IP="$lab_server_ip,$proxy_ip" -e SSL_EXPIRE="90" -e SSL_SUBJECT="$lab_server_ip.nip.io" paulczar/omgwtfssl
#sudo cat /alphabravo/misc/certs/cert.pem /alphabravo/misc/certs/ca.pem > /alphabravo/misc/certs/fullchain.pem
sudo cat /alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io.pem /root/.local/share/mkcert/rootCA.pem /alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io-key.pem > /alphabravo/misc/certs/cert-bundle.pem
cd ~

## Copy generated TLS keys to lab-server
scp -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no /alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io.pem $user@$lab_server_ip:/alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io.pem
scp -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no /alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io-key.pem $user@$lab_server_ip:/alphabravo/misc/certs/_wildcard.$proxy_ip.nip.io-key.pem
scp -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no /root/.local/share/mkcert/rootCA.pem $user@$lab_server_ip:/alphabravo/misc/certs/proxy_rootCA.pem

## Install HAProxy
apt install haproxy -y
cp /tmp/haproxy.cfg /etc/haproxy/haproxy.cfg
chown haproxy:haproxy /etc/haproxy/haproxy.cfg
systemctl restart haproxy